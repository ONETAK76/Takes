<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Takes ‚Äì –ê–∫—Ç I</title>
<style>
body{font-family:system-ui,monospace;background:#111;color:#0f0;margin:0;padding:8px;display:flex;flex-direction:column;height:100vh}
#top{flex:1 1 90vh;display:flex;flex-direction:column}
#out{flex:1;white-space:pre-wrap;overflow-y:scroll;border:1px solid #0f0;padding:6px}
#hpBar{position:sticky;top:0;background:#111;border-bottom:1px solid #0f0;padding:4px;display:flex;align-items:center;gap:6px}
.heart{font-size:20px}
#bottom{flex:0 0 auto;display:flex;gap:6px;align-items:center}
#in{flex:1;font-size:18px;background:#000;color:#0f0;border:1px solid #0f0;padding:4px}
#sendBtn{font-size:20px;padding:8px 16px;height:48px;background:#000;color:#0f0;border:1px solid #0f0;cursor:pointer}
button{background:#000;color:#0f0;border:1px solid #0f0;padding:6px;margin:2px;cursor:pointer}
input[type=text],textarea,select{background:#000;color:#0f0;border:1px solid #0f0;padding:4px;margin:2px;width:100%}
#fileIn{display:none}

/* –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center}
.box{background:#111;border:2px solid #0f0;padding:12px;width:340px;max-height:70vh;overflow-y:auto}
.invLine{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px;border:1px solid #0a0}
.invIcon{font-size:22px}
.statRow{display:flex;justify-content:space-between;margin-bottom:6px}
</style>
</head>
<body>
<div id="hpBar"><span id="hearts"></span> | –£—Ä–æ–≤–µ–Ω—å <span id="lvl">1</span> | –û–ø—ã—Ç <span id="exp">0</span>/<span id="expNext">10</span></div>
<div id="top">
  <div id="out">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´Takes¬ª!<br>–ê–∫—Ç I: ¬´–ü–∏—Å—å–º–∞ –ø—Ä–æ—à–ª–æ–≥–æ¬ª<br>–ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è ‚Äî –Ω–∞–±–µ—Ä–∏—Ç–µ <b>–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</b></div>
</div>
<div id="bottom">
  <input id="in" placeholder="&gt; –∫–æ–º–∞–Ω–¥–∞" autofocus>
  <button id="sendBtn" onclick="send()">‚Üµ</button>
  <button onclick="saveGame()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="loadGame()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <input type="file" id="fileIn" accept=".txt,.json">
</div>

<!-- –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
<div id="invModal" class="modal" onclick="closeInv(event)">
  <div class="box" onclick="event.stopPropagation()">
    <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
    <div id="invList">–ü—É—Å—Ç–æ</div>
    <button onclick="closeInv()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
<div id="statModal" class="modal" onclick="closeStat(event)">
  <div class="box" onclick="event.stopPropagation()">
    <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
    <div id="statList"></div>
    <button onclick="closeStat()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
/******************************************************************
 *                        –°–¶–ï–ù–ê–†–ò–ô + –°–¢–ê–¢–´
 ******************************************************************/
const DEFAULT_WORLD={
  meta:{title:"–ê–∫—Ç I: –ü–∏—Å—å–º–∞ –ø—Ä–æ—à–ª–æ–≥–æ",act:1},
  start:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",
  playerRoom:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",
  inv:[],
  flags:[],
  rooms:{
    "–∫–≤–∞—Ä—Ç–∏—Ä–∞":{
      name:"–°—Ç–∞—Ä–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
      desc:"–ü—ã–ª—å–Ω—ã–µ –æ–∫–Ω–∞, —Å—Ç—É–∫ —á–∞—Å–æ–≤. –ù–∞ —Å—Ç–æ–ª–µ –ø–∏—Å—å–º–æ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è. –í –∫–æ—Ä–∏–¥–æ—Ä ‚Äì –Ω–∞ —Å–µ–≤–µ—Ä.",
      exits:{—Å–µ–≤–µ—Ä:"–∫–æ—Ä–∏–¥–æ—Ä"},
      items:["–ø–∏—Å—å–º–æ","—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"]
    },
    "–∫–æ—Ä–∏–¥–æ—Ä":{
      name:"–ö–æ—Ä–∏–¥–æ—Ä",
      desc:"–¢—É—Å–∫–ª—ã–π —Å–≤–µ—Ç. –Æ–≥ ‚Äì –∫–≤–∞—Ä—Ç–∏—Ä–∞; –≤–æ—Å—Ç–æ–∫ ‚Äì —á–µ—Ä–¥–∞–∫; –∑–∞–ø–∞–¥ ‚Äì –ø–æ–¥–≤–∞–ª; —Å–µ–≤–µ—Ä ‚Äì –∫–ª–∞–¥–æ–≤–∫–∞; –≤–≤–µ—Ä—Ö ‚Äì —á–µ—Ä–¥–∞—á–Ω—ã–π –ª—é–∫ (–∑–∞–ø–µ—Ä—Ç).",
      exits:{—é–≥:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",–≤–æ—Å—Ç–æ–∫:"—á–µ—Ä–¥–∞–∫",–∑–∞–ø–∞–¥:"–ø–æ–¥–≤–∞–ª",—Å–µ–≤–µ—Ä:"–∫–ª–∞–¥–æ–≤–∫–∞"}
    },
    "—á–µ—Ä–¥–∞–∫":{
      name:"–ó–∞–ø—ã–ª–∏–≤—à–∏–π—Å—è —á–µ—Ä–¥–∞–∫",
      desc:"–ü–∞—Ö–Ω–µ—Ç —Å—Ç–∞—Ä–æ–π –±—É–º–∞–≥–æ–π. –ù–∞ –ø–æ–ª—É —à–∫–∞—Ç—É–ª–∫–∞.",
      exits:{–∑–∞–ø–∞–¥:"–∫–æ—Ä–∏–¥–æ—Ä"},
      items:["—à–∫–∞—Ç—É–ª–∫–∞"]
    },
    "–ø–æ–¥–≤–∞–ª":{
      name:"–¢—ë–º–Ω—ã–π –ø–æ–¥–≤–∞–ª",
      desc:"–°—ã—Ä–æ—Å—Ç—å. –í —É–≥–ª—É —Å—Ç–æ–∏—Ç –∑–∞–ø–µ—Ä—Ç—ã–π —á–µ–º–æ–¥–∞–Ω.",
      exits:{–≤–æ—Å—Ç–æ–∫:"–∫–æ—Ä–∏–¥–æ—Ä"},
      items:["—á–µ–º–æ–¥–∞–Ω"]
    },
    "–∫–ª–∞–¥–æ–≤–∫–∞":{
      name:"–ó–∞–ø–µ—Ä—Ç–∞—è –∫–ª–∞–¥–æ–≤–∫–∞",
      desc:"–ü–∞—Ö–Ω–µ—Ç —Å—ã—Ä–æ—Å—Ç—å—é. –ù–∞ —Å—Ç–µ–Ω–µ –≤–∏—Å–∏—Ç —Å—Ç–∞—Ä—ã–π –∫—Ä—é—á–æ–∫.",
      exits:{—é–≥:"–∫–æ—Ä–∏–¥–æ—Ä"},
      items:["–∫—Ä—é—á–æ–∫"]
    },
    /* –Ω–æ–≤—ã–µ –ª–æ–∫–∞—Ü–∏–∏ */
    "–æ–∑–µ—Ä–æ":{
      name:"–ó–∞–º—ë—Ä–∑—à–µ–µ –æ–∑–µ—Ä–æ",
      desc:"–ü–æ —Ü–µ–Ω—Ç—Ä—É ‚Äì –ø—Ä–æ–≤–∞–ª. –ü–æ–¥ –ª—å–¥–æ–º –¥–≤–∏–∂–µ—Ç—Å—è —Ç–µ–Ω—å‚Ä¶ –ú–æ–Ω—Å—Ç—Ä!",
      exits:{—é–≥:"–ª–µ—Å"},
      monster:{hp:100,maxHp:100,name:"–õ–µ–¥—è–Ω–æ–π —É–∂–∞—Å",dmg:[5,15]}
    },
    "–ª–µ—Å":{
      name:"–¢—ë–º–Ω—ã–π –ª–µ—Å",
      desc:"–ß—É—Ç—å —Å–ª—ã—à–Ω–æ –≤–æ—Ä–æ–Ω—å—ë. –¢—Ä–æ–ø—ã –Ω–∞ —Å–µ–≤–µ—Ä (–æ–∑–µ—Ä–æ) –∏ –≤–æ—Å—Ç–æ–∫ (—Ä–æ–≤).",
      exits:{—Å–µ–≤–µ—Ä:"–æ–∑–µ—Ä–æ",–≤–æ—Å—Ç–æ–∫:"—Ä–æ–≤"}
    },
    "—Ä–æ–≤":{
      name:"–ó–∞—Ä–æ—Å—à–∏–π —Ä–æ–≤",
      desc:"–í—ã—Å–æ–∫–∏–µ —Ç—Ä–∞–≤—ã. –ù–∞ –¥–Ω–µ ‚Äì –∫–æ—Å—Ç–∏ –∏ –±–ª–µ—Å–∫ –º–µ—Ç–∞–ª–ª–∞.",
      exits:{–∑–∞–ø–∞–¥:"–ª–µ—Å",—é–≥:"–ø–µ—â–µ—Ä–∞"},
      items:["–º–µ—á_—Ä—É–±–ª–∏"],
      monster:{hp:60,maxHp:60,name:"–¢—Ä–∞–≤—è–Ω–æ–π –¥—É—Ö",dmg:[3,12]}
    },
    "–ø–µ—â–µ—Ä–∞":{
      name:"–°—ã—Ä–∞—è –ø–µ—â–µ—Ä–∞",
      desc:"–ö–∞–ø–∞–µ—Ç –≤–æ–¥–∞. –í –≥–ª—É–±–∏–Ω–µ ‚Äì —Å–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä–∏—Å—Ç–∞–ª–ª.",
      exits:{—Å–µ–≤–µ—Ä:"—Ä–æ–≤"},
      items:["–∫—Ä–∏—Å—Ç–∞–ª–ª"],
      randomEvent:{chance:1,msg:"–° –ø–æ—Ç–æ–ª–∫–∞ —Å—ã–ø–µ—Ç—Å—è –ø–µ—Å–æ–∫ ‚Äì –ª–æ–≤—É—à–∫–∞! -10 HP.",effect:"trap"}
    },
    "—Ä–∞–∑–≤–∞–ª–∏–Ω—ã":{
      name:"–î—Ä–µ–≤–Ω–∏–µ —Ä–∞–∑–≤–∞–ª–∏–Ω—ã",
      desc:"–û–±—Ä—É—à–∏–≤—à–∏–µ—Å—è —Å—Ç–µ–Ω—ã. –í —Ü–µ–Ω—Ç–µ—Ä–µ ‚Äì –∞–ª—Ç–∞—Ä—å.",
      exits:{–≤–æ—Å—Ç–æ–∫:"–∫–æ—Ä–∏–¥–æ—Ä"},
      items:["–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π_–∫–ª–∏–Ω–æ–∫"],
      monster:{hp:150,maxHp:150,name:"–ö–∞–º–µ–Ω–Ω—ã–π –≥–æ–ª–µ–º",dmg:[10,20]}
    }
  },
  items:{
    "–ø–∏—Å—å–º–æ":{name:"–ø–∏—Å—å–º–æ",desc:"–ö–æ—Ä–æ—Ç–∫–æ–µ –ø–∏—Å—å–º–æ: ¬´–ï—Å–ª–∏ —Ç—ã —ç—Ç–æ —á–∏—Ç–∞–µ—à—å ‚Äì –∑–Ω–∞—á–∏—Ç, —è –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è. –ò—â–∏ –∫–ª—é—á –≤ —à–∫–∞—Ç—É–ª–∫–µ¬ª.",icon:"üìù"},
    "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è":{name:"—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è",desc:"–°–Ω–∏–º–æ–∫: —Ç—ã –∏ —Å–µ—Å—Ç—Ä–∞ —É –æ–∑–µ—Ä–∞. –ù–∞ –æ–±–æ—Ä–æ—Ç–µ –Ω–∞–¥–ø–∏—Å—å ¬´–õ–µ—Ç–æ 1999¬ª.",icon:"üñºÔ∏è"},
    "—à–∫–∞—Ç—É–ª–∫–∞":{name:"—à–∫–∞—Ç—É–ª–∫–∞",desc:"–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è, –∫—Ä–µ–ø–∫–æ –∑–∞–ø–µ—Ä—Ç–∞.",icon:"üóÉÔ∏è"},
    "—á–µ–º–æ–¥–∞–Ω":{name:"—á–µ–º–æ–¥–∞–Ω",desc:"–ö–æ–∂–∞–Ω—ã–π, —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏ ¬´–ê.–®.¬ª –ó–∞–ø–µ—Ä—Ç –Ω–∞ –Ω–∞–≤–µ—Å–Ω–æ–π –∑–∞–º–æ–∫.",icon:"üß≥"},
    "–∫—Ä—é—á–æ–∫":{name:"—Ç–æ–ª—Å—Ç—ã–π –∫—Ä—é—á–æ–∫",desc:"–†–∂–∞–≤—ã–π, –Ω–æ –ø—Ä–æ—á–Ω—ã–π. –ú–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –∑–∞–º–æ–∫.",icon:"ü™ù"},
    "–∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏":{name:"–º–∞–ª–µ–Ω—å–∫–∏–π –∫–ª—é—á",desc:"–õ—ë–≥–∫–∏–π, —Å —É–∑–∫–∏–º —Å—Ç–µ—Ä–∂–Ω–µ–º ‚Äì –ø–æ—Ö–æ–∂–µ, –æ—Ç —à–∫–∞—Ç—É–ª–∫–∏.",icon:"üóùÔ∏è"},
    "–∑–∞–ø–∏—Å–∫–∞":{name:"–∑–∞–ø–∏—Å–∫–∞",desc:"¬´–ö–ª—é—á –æ—Ç —à–∫–∞—Ç—É–ª–∫–∏ —è —Å–ø—Ä—è—Ç–∞–ª –≤ –∫–ª–∞–¥–æ–≤–∫–µ ‚Äì –Ω–∞ –∫—Ä—é—á–∫–µ¬ª.",icon:"üìÑ"},
    "–¥—É–±–∏–Ω–∞":{name:"–¥—É–±–∏–Ω–∞",desc:"–¢—è–∂—ë–ª—ã–π –∫—É—Å–æ–∫ –¥–µ—Ä–µ–≤–∞. +3 –∫ —É—Ä–æ–Ω—É.",icon:"üèè",atk:3},
    "–º–µ—á_—Ä—É–±–ª–∏":{name:"—Å—Ç–∞—Ä—ã–π –º–µ—á",desc:"–†–∂–∞–≤—ã–π, –Ω–æ –æ—Å—Ç—Ä—ã–π. +4 –∫ —É—Ä–æ–Ω—É.",icon:"‚öîÔ∏è",atk:4},
    "–∫—Ä–∏—Å—Ç–∞–ª–ª":{name:"—Å–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä–∏—Å—Ç–∞–ª–ª",desc:"–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –∏–ª–∏ –≤–ø–∏—Ç–∞—Ç—å —Å–∏–ª—É. +5 –æ–ø—ã—Ç–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.",icon:"üíé",exp:5},
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π_–∫–ª–∏–Ω–æ–∫":{name:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–ª–∏–Ω–æ–∫",desc:"–ë–ª–µ—Å—Ç–∏—Ç –¥—Ä–µ–≤–Ω–∏–º —Å–≤–µ—Ç–æ–º. +7 –∫ —É—Ä–æ–Ω—É.",icon:"üó°Ô∏è",atk:7},
    "–∫–ª—é—á":{name:"–ª–∞—Ç—É–Ω–Ω—ã–π –∫–ª—é—á",desc:"–¢—è–∂—ë–ª—ã–π, —Å –∑—É–±—á–∏–∫–∞–º–∏ –Ω–µ–æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã.",icon:"üóùÔ∏è"}
  },
  npcs:{},
  triggers:[
    {cond:"has –∫—Ä—é—á–æ–∫ and in –ø–æ–¥–≤–∞–ª and has —á–µ–º–æ–¥–∞–Ω",act:"msg –í—ã –ø–æ–¥–¥–µ–≤–∞–µ—Ç–µ –∑–∞–º–æ–∫ –∫—Ä—é—á–∫–æ–º ‚Äì –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è!;remove —á–µ–º–æ–¥–∞–Ω;give –∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏;give –∑–∞–ø–∏—Å–∫–∞"},
    {cond:"has –∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏ and in —á–µ—Ä–¥–∞–∫ and has —à–∫–∞—Ç—É–ª–∫–∞",act:"msg –®–∫–∞—Ç—É–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞! –í–Ω—É—Ç—Ä–∏ ‚Äì –ª–∞—Ç—É–Ω–Ω—ã–π –∫–ª—é—á.;remove —à–∫–∞—Ç—É–ª–∫–∞;give –∫–ª—é—á"},
    {cond:"has –∫–ª—é—á and in –∫–≤–∞—Ä—Ç–∏—Ä–∞",act:"msg –ö–ª—é—á –ø–æ–¥–æ—à—ë–ª –∫ —Å—Ç–∞—Ä–æ–º—É —Å–µ–π—Ñ—É –≤ —Å—Ç–µ–Ω–µ!;create exit –Ω–∞–≤–µ—Ä—Ö —Ñ–∏–Ω–∞–ª;flag –∞–∫—Ç_–∑–∞–≤–µ—Ä—à—ë–Ω"}
  ],
  randomEvents:[
    {chance:0.2,msg:"–ß–∞—Å—ã –Ω–∞ —Å—Ç–µ–Ω–µ –ø—Ä–æ–±–∏–ª–∏ –ø–æ–ª–Ω–æ—á—å.",effect:"none"},
    {chance:0.15,msg:"–í—ã –Ω–∞—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ –ø–∞—É—Ç–∏–Ω—É.",effect:"skip"},
    {chance:0.1,msg:"–ü–æ–¥ –Ω–æ–≥–∞–º–∏ —Ö—Ä—É—Å—Ç–Ω—É–ª–æ —Å—Ç–µ–∫–ª–æ.",effect:"none"}
  ],
  player:{
    hp:30,maxHp:30,atk:5,def:0,
    lvl:1,exp:0,expNext:10,
    freePoints:0,
    equipped:null
  }
};

let world=JSON.parse(localStorage.getItem('zworld_save_v1')||JSON.stringify(DEFAULT_WORLD));
function save(){localStorage.setItem('zworld_save_v1',JSON.stringify(world))}
function out(s){document.getElementById('out').innerHTML+=`<br>${s}`; scrollToEnd();}
function scrollToEnd(){const o=document.getElementById('out'); o.scrollTop=o.scrollHeight;}

/* ---------- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ ---------- */
function renderHP(){
  const p=world.player;
  document.getElementById('hearts').innerHTML='‚ù§Ô∏è'.repeat(Math.ceil(p.hp/10))+'üñ§'.repeat(Math.ceil((p.maxHp-p.hp)/10));
  document.getElementById('lvl').textContent=p.lvl;
  document.getElementById('exp').textContent=p.exp;
  document.getElementById('expNext').textContent=p.expNext;
}
function gainExp(am){
  const p=world.player;
  p.exp+=am;
  while(p.exp>=p.expNext){
    p.exp-=p.expNext;
    p.lvl++; p.freePoints++; p.expNext=10+p.lvl*5;
    out(`üìà –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! +1 –æ—á–∫–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.`);
  }
  renderHP(); save();
}

/* ---------- –±–æ–µ–≤–æ–π —Ü–∏–∫–ª ---------- */
let combatTurn=null;
function startCombat(){
  const m=world.rooms[world.playerRoom].monster;
  if(!m||m.hp<=0) return;
  out(`‚öîÔ∏è ${m.name} –Ω–∞–ø–∞–¥–∞–µ—Ç! –í–≤–æ–¥–∏—Ç–µ "–∞—Ç–∞–∫–∞" —á—Ç–æ–±—ã –±–∏—Ç—å.`);
  combatTurn=setInterval(()=>{
    if(m.hp<=0){endCombat(true); return;}
    const dmg=rand(m.dmg[0],m.dmg[1])-world.player.def;
    world.player.hp-=Math.max(0,dmg);
    out(`üí• ${m.name} –±—å—ë—Ç –≤–∞—Å –Ω–∞ ${dmg} —É—Ä–æ–Ω–∞.`);
    if(world.player.hp<=0){endCombat(false); return;}
    renderHP(); save();
  },3000);
}
function endCombat(win){
  clearInterval(combatTurn); combatTurn=null;
  const m=world.rooms[world.playerRoom].monster;
  if(win){
    out(`üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏ ${m.name}! +30 –æ–ø—ã—Ç–∞.`);
    gainExp(30);
    delete world.rooms[world.playerRoom].monster;
  }else{
    out(`üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏. –ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ.`);
    setTimeout(()=>{localStorage.removeItem('zworld_save_v1'); location.reload();},2000);
  }
  save();
}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

/* ---------- –∫–æ–º–∞–Ω–¥—ã ---------- */
function send(){
  const raw=document.getElementById('in').value.trim();
  if(!raw)return;
  out(`> ${raw}`);
  document.getElementById('in').value='';
  if(raw.startsWith('!edit')){
    const wish=raw.slice(5).trim();
    if(wish)applySimpleEdit(wish);
    return;
  }
  parse(raw.toLowerCase());
  save();
}
function parse(cmd){
  const [a,...b]=cmd.split(' '); const arg=b.join(' ');
  switch(a){
    case '–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è':look();break;
    case '–∏–¥—Ç–∏':go(arg);break;
    case '–≤–∑—è—Ç—å':take(arg);break;
    case '–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å':openInv();break;
    case '–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å':use(arg);break;
    case '–æ—Å–º–æ—Ç—Ä–µ—Ç—å':examine(arg);break;
    case '–∞—Ç–∞–∫–∞':playerAttack();break;
    case '—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏':openStat();break;
    default:out('–ù–µ –ø–æ–Ω—è–ª: –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è, –∏–¥—Ç–∏ <–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ>, –≤–∑—è—Ç—å <–ø—Ä–µ–¥–º–µ—Ç>, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <–ø—Ä–µ–¥–º–µ—Ç>, –æ—Å–º–æ—Ç—Ä–µ—Ç—å <–ø—Ä–µ–¥–º–µ—Ç>, –∞—Ç–∞–∫–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏');
  }
}
function look(){
  const r=world.rooms[world.playerRoom];
  out(`<b>${r.name}</b><br>${r.desc}`);
  if(r.items&&r.items.length)out('–ó–¥–µ—Å—å: '+r.items.map(i=>world.items[i].name).join(', '));
  if(r.npc&&r.npc.length)out('–†—è–¥–æ–º: '+r.npc.map(n=>world.npcs[n].name).join(', '));
  if(r.exits&&Object.keys(r.exits).length)out('–í—ã—Ö–æ–¥—ã: '+Object.keys(r.exits).join(', '));
  if(r.monster&&r.monster.hp>0)startCombat();
  /* —Å—é–∂–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤–Ω—É—Ç—Ä–∏ –ª–æ–∫–∞—Ü–∏–∏ */
  if(r.randomEvent&&Math.random()<r.randomEvent.chance){
    const e=r.randomEvent;
    out(e.msg);
    if(e.effect==='trap'){world.player.hp-=10; renderHP();}
    if(e.effect==='give'){world.inv.push(e.item); out('–ü–æ–ª—É—á–µ–Ω–æ: '+world.items[e.item].name);}
    delete r.randomEvent;
  }
  checkTriggers();
  tryRandomEvent();
}
function go(dir){
  const r=world.rooms[world.playerRoom];
  if(r.exits&&r.exits[dir]){
    if(combatTurn){out('üíÄ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–±–µ–∂–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –±–æ—è!'); return;}
    world.playerRoom=r.exits[dir]; look();
  }else out('–¢—É–¥–∞ –Ω–µ–ª—å–∑—è.');
}
function take(name){
  const r=world.rooms[world.playerRoom];
  if(!r.items){out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');return;}
  const it=r.items.find(i=>world.items[i].name.toLowerCase()===name);
  if(it){r.items=r.items.filter(x=>x!==it); world.inv.push(it); out('–í–∑—è–ª–∏ '+world.items[it].name); save();}
  else out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');
}
function use(name){
  const it=world.inv.find(i=>world.items[i].name.toLowerCase()===name);
  if(!it){out('–ù–µ—Ç.');return;}
  /* —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –æ—Ä—É–∂–∏—è */
  if(it==='–¥—É–±–∏–Ω–∞'||it==='–º–µ—á_—Ä—É–±–ª–∏'||it==='–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π_–∫–ª–∏–Ω–æ–∫'){
    if(world.player.equipped===it){out('–£–∂–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ.'); return;}
    world.player.equipped=it;
    out(`‚öîÔ∏è ${world.items[it].name} —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω.`);
    save(); return;
  }
  /* –∫—Ä–∏—Å—Ç–∞–ª–ª –æ–ø—ã—Ç–∞ */
  if(it==='–∫—Ä–∏—Å—Ç–∞–ª–ª'){
    world.inv=world.inv.filter(x=>x!=='–∫—Ä–∏—Å—Ç–∞–ª–ª');
    gainExp(world.items.–∫—Ä–∏—Å—Ç–∞–ª–ª.exp||5);
    return;
  }
  checkTriggers();
}
function examine(name){
  let it=world.inv.find(i=>world.items[i].name.toLowerCase()===name);
  if(!it){
    const r=world.rooms[world.playerRoom];
    if(r.items) it=r.items.find(i=>world.items[i].name.toLowerCase()===name);
  }
  if(it){const t=world.items[it]; out(`${t.icon||'üì¶'} ${t.name} ‚Äì ${t.desc}`);}
  else out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');
}
function playerAttack(){
  const m=world.rooms[world.playerRoom].monster;
  if(!m||m.hp<=0){out('–ù–µ–∫–æ–≥–æ –±–∏—Ç—å.'); return;}
  let dmg=world.player.atk;
  const w=world.player.equipped;
  if(w) dmg+=world.items[w].atk||0;
  dmg=rand(dmg-2,dmg+2);
  m.hp-=Math.max(0,dmg);
  out(`‚öîÔ∏è –í—ã –±—å—ë—Ç–µ –Ω–∞ ${dmg} —É—Ä–æ–Ω–∞. –£ –º–æ–Ω—Å—Ç—Ä–∞ ${Math.max(0,m.hp)}/${m.maxHp} HP.`);
  if(m.hp<=0)endCombat(true);
  save();
}
function endCombat(win){
  clearInterval(combatTurn); combatTurn=null;
  const m=world.rooms[world.playerRoom].monster;
  if(win){
    out(`üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏ ${m.name}! +${m.exp||30} –æ–ø—ã—Ç–∞.`);
    gainExp(m.exp||30);
    delete world.rooms[world.playerRoom].monster;
  }else{
    out(`üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏. –ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ.`);
    setTimeout(()=>{localStorage.removeItem('zworld_save_v1'); location.reload();},2000);
  }
  save();
}
function gainExp(am){
  const p=world.player;
  p.exp+=am;
  while(p.exp>=p.expNext){
    p.exp-=p.expNext;
    p.lvl++; p.freePoints++; p.expNext=10+p.lvl*5;
    out(`üìà –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! +1 –æ—á–∫–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.`);
  }
  renderHP(); save();
}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

/* ---------- –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å ---------- */
function openInv(){
  const list=document.getElementById('invList');
  if(!world.inv.length){list.innerHTML='–ü—É—Å—Ç–æ';}
  else{
    list.innerHTML=world.inv.map(i=>{
      const it=world.items[i];
      let btns='';
      if(it.atk) btns='<button onclick="use(\''+i+'\')">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>';
      return `<div class="invLine"><span class="invIcon">${it.icon||'üì¶'}</span><div><b>${it.name}</b><br><small>${it.desc}</small>${btns?' '+btns:''}</div></div>`;
    }).join('');
  }
  document.getElementById('invModal').style.display='flex';
}
function closeInv(ev){
  if(!ev||ev.target.classList.contains('modal')) document.getElementById('invModal').style.display='none';
}
/* ---------- —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ---------- */
function openStat(){
  const p=world.player;
  const list=document.getElementById('statList');
  list.innerHTML=`
    <div class="statRow"><span>‚ù§Ô∏è –ñ–∏–∑–Ω–∏</span><span>${p.hp}/${p.maxHp}</span>${p.freePoints?'<button onclick="spend(\'maxHp\')">+5</button>':''}</div>
    <div class="statRow"><span>‚öîÔ∏è –ê—Ç–∞–∫–∞</span><span>${p.atk}</span>${p.freePoints?'<button onclick="spend(\'atk\')">+1</button>':''}</div>
    <div class="statRow"><span>üõ°Ô∏è –ó–∞—â–∏—Ç–∞</span><span>${p.def}</span>${p.freePoints?'<button onclick="spend(\'def\')">+1</button>':''}</div>
    <div class="statRow"><span>üí° –û—á–∫–∏</span><span>${p.freePoints}</span></div>
  `;
  document.getElementById('statModal').style.display='flex';
}
function closeStat(ev){
  if(!ev||ev.target.classList.contains('modal')) document.getElementById('statModal').style.display='none';
}
function spend(stat){
  const p=world.player;
  if(p.freePoints<=0)return;
  p.freePoints--;
  if(stat==='maxHp'){p.maxHp+=5; p.hp+=5;}
  if(stat==='atk')p.atk+=1;
  if(stat==='def')p.def+=1;
  renderHP(); openStat(); save();
}
/* ---------- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ ---------- */
function saveGame(){
  const data=JSON.stringify(world,null,2);
  const blob=new Blob([data],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='Takes_save_'+new Date().toISOString().slice(0,10)+'.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  out('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');
}
function loadGame(){
  document.getElementById('fileIn').click();
}
document.getElementById('fileIn').addEventListener('change',function(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=JSON.parse(ev.target.result);
      Object.assign(world,data);
      save(); location.reload();
    }catch(err){alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: '+err.message);}
  };
  reader.readAsText(file);
});
/* ---------- —Å—Ç–∞—Ä—Ç ---------- */
renderHP(); look(); save();
document.getElementById('in').addEventListener('keydown',e=>{if(e.key==='Enter')send()});
</script>
</body>
</html>
