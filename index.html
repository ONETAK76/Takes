<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Takes ‚Äì –ê–∫—Ç I</title>
<style>
:root{
  --bg:#0d1117;
  --panel:#161b22;
  --border:#30363d;
  --text:#c9d1d9;
  --accent:#58a6ff;
  --green:#3fb950;
  --red:#f85149;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif}
body{margin:0;height:100vh;display:flex;background:var(--bg);color:var(--text)}
#left{flex:1 1 60%;display:flex;flex-direction:column;padding:8px;gap:8px}
#screen{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:15px;line-height:1.4;white-space:pre-wrap;overflow-y:auto;flex:1}
#avatar{display:flex;align-items:center;gap:12px;margin-bottom:8px}
#avatar img{width:64px;height:64px;border-radius:50%;border:2px solid var(--accent)}
#hpBar{display:flex;gap:12px;align-items:center;font-size:14px}
.heart{font-size:18px}
#inputRow{display:flex;gap:6px}
#in{flex:1;padding:8px 10px;font-size:16px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:4px}
#sendBtn{padding:8px 14px;background:var(--accent);color:#fff;border:none;border-radius:4px;font-weight:600;cursor:pointer}
#right{width:280px;background:var(--panel);border-left:1px solid var(--border);padding:12px;display:flex;flex-direction:column}
#right h3{margin:0 0 8px;font-size:16px}
#invGrid{display:flex;flex-direction:column;gap:6px;overflow-y:auto}
.invSlot{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid var(--border);border-radius:4px}
.invIcon{font-size:24px}
.invSlot button{margin-left:auto;padding:4px 8px;font-size:12px;background:var(--accent);color:#fff;border:none;border-radius:3px;cursor:pointer}
button:hover{filter:brightness(1.15)}
</style>
</head>
<body>
<div id="left">
  <div id="screen">
    <div id="avatar">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2358a6ff'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='50' fill='%23fff'%3Eüßç%3C/text%3E%3C/svg%3E" alt="avatar">
      <div>
        <div id="hpBar"><span id="hearts"></span> | –£—Ä. <span id="lvl">1</span> | –û–ø—ã—Ç <span id="exp">0</span>/<span id="expNext">10</span></div>
        <small>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è, –∏–¥—Ç–∏ &lt;–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ&gt;, –≤–∑—è—Ç—å &lt;–ø—Ä–µ–¥–º–µ—Ç&gt;, –∞—Ç–∞–∫–∞</small>
      </div>
    </div>
    <div id="out">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´Takes¬ª! –ê–∫—Ç I: ¬´–ü–∏—Å—å–º–∞ –ø—Ä–æ—à–ª–æ–≥–æ¬ª&#10;–ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è ‚Äî –Ω–∞–±–µ—Ä–∏—Ç–µ <b>–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</b></div>
  </div>
  <div id="inputRow">
    <input id="in" placeholder="> –∫–æ–º–∞–Ω–¥–∞" autofocus>
    <button id="sendBtn" onclick="send()">‚Üµ</button>
    <button onclick="saveGame()">üíæ</button>
    <button onclick="loadGame()">üìÇ</button>
    <input type="file" id="fileIn" accept=".txt,.json" style="display:none">
  </div>
</div>

<div id="right">
  <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
  <div id="invGrid"></div>
</div>

<script>
/******************************************************************
 *                        –î–ê–ù–ù–´–ï
 ******************************************************************/
const DEFAULT_WORLD={
  meta:{title:"–ê–∫—Ç I: –ü–∏—Å—å–º–∞ –ø—Ä–æ—à–ª–æ–≥–æ",act:1},
  start:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",
  playerRoom:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",
  inv:[],
  flags:[],
  rooms:{
    "–∫–≤–∞—Ä—Ç–∏—Ä–∞":{name:"–°—Ç–∞—Ä–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",desc:"–ü—ã–ª—å–Ω—ã–µ –æ–∫–Ω–∞, —Å—Ç—É–∫ —á–∞—Å–æ–≤. –ù–∞ —Å—Ç–æ–ª–µ –ø–∏—Å—å–º–æ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è. –í –∫–æ—Ä–∏–¥–æ—Ä ‚Äì –Ω–∞ —Å–µ–≤–µ—Ä.",exits:{—Å–µ–≤–µ—Ä:"–∫–æ—Ä–∏–¥–æ—Ä"},items:["–ø–∏—Å—å–º–æ","—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"]},
    "–∫–æ—Ä–∏–¥–æ—Ä":{name:"–ö–æ—Ä–∏–¥–æ—Ä",desc:"–¢—É—Å–∫–ª—ã–π —Å–≤–µ—Ç. –Æ–≥ ‚Äì –∫–≤–∞—Ä—Ç–∏—Ä–∞; –≤–æ—Å—Ç–æ–∫ ‚Äì —á–µ—Ä–¥–∞–∫; –∑–∞–ø–∞–¥ ‚Äì –ø–æ–¥–≤–∞–ª; —Å–µ–≤–µ—Ä ‚Äì –∫–ª–∞–¥–æ–≤–∫–∞.",exits:{—é–≥:"–∫–≤–∞—Ä—Ç–∏—Ä–∞",–≤–æ—Å—Ç–æ–∫:"—á–µ—Ä–¥–∞–∫",–∑–∞–ø–∞–¥:"–ø–æ–¥–≤–∞–ª",—Å–µ–≤–µ—Ä:"–∫–ª–∞–¥–æ–≤–∫–∞"}},
    "—á–µ—Ä–¥–∞–∫":{name:"–ó–∞–ø—ã–ª–∏–≤—à–∏–π—Å—è —á–µ—Ä–¥–∞–∫",desc:"–ü–∞—Ö–Ω–µ—Ç —Å—Ç–∞—Ä–æ–π –±—É–º–∞–≥–æ–π. –ù–∞ –ø–æ–ª—É —à–∫–∞—Ç—É–ª–∫–∞.",exits:{–∑–∞–ø–∞–¥:"–∫–æ—Ä–∏–¥–æ—Ä"},items:["—à–∫–∞—Ç—É–ª–∫–∞"]},
    "–ø–æ–¥–≤–∞–ª":{name:"–¢—ë–º–Ω—ã–π –ø–æ–¥–≤–∞–ª",desc:"–°—ã—Ä–æ—Å—Ç—å. –í —É–≥–ª—É —Å—Ç–æ–∏—Ç –∑–∞–ø–µ—Ä—Ç—ã–π —á–µ–º–æ–¥–∞–Ω.",exits:{–≤–æ—Å—Ç–æ–∫:"–∫–æ—Ä–∏–¥–æ—Ä"},items:["—á–µ–º–æ–¥–∞–Ω"]},
    "–∫–ª–∞–¥–æ–≤–∫–∞":{name:"–ó–∞–ø–µ—Ä—Ç–∞—è –∫–ª–∞–¥–æ–≤–∫–∞",desc:"–ü–∞—Ö–Ω–µ—Ç —Å—ã—Ä–æ—Å—Ç—å—é. –ù–∞ —Å—Ç–µ–Ω–µ –≤–∏—Å–∏—Ç —Å—Ç–∞—Ä—ã–π –∫—Ä—é—á–æ–∫.",exits:{—é–≥:"–∫–æ—Ä–∏–¥–æ—Ä"},items:["–∫—Ä—é—á–æ–∫"]},
    "–æ–∑–µ—Ä–æ":{name:"–ó–∞–º—ë—Ä–∑—à–µ–µ –æ–∑–µ—Ä–æ",desc:"–ü–æ —Ü–µ–Ω—Ç—Ä—É ‚Äì –ø—Ä–æ–≤–∞–ª. –ü–æ–¥ –ª—å–¥–æ–º –¥–≤–∏–∂–µ—Ç—Å—è —Ç–µ–Ω—å‚Ä¶ –ú–æ–Ω—Å—Ç—Ä!",exits:{—é–≥:"–ª–µ—Å"},monster:{hp:100,maxHp:100,name:"–õ–µ–¥—è–Ω–æ–π —É–∂–∞—Å",dmg:[5,15],exp:30}},
    "–ª–µ—Å":{name:"–¢—ë–º–Ω—ã–π –ª–µ—Å",desc:"–ß—É—Ç—å —Å–ª—ã—à–Ω–æ –≤–æ—Ä–æ–Ω—å—ë. –¢—Ä–æ–ø—ã –Ω–∞ —Å–µ–≤–µ—Ä (–æ–∑–µ—Ä–æ) –∏ –≤–æ—Å—Ç–æ–∫ (—Ä–æ–≤).",exits:{—Å–µ–≤–µ—Ä:"–æ–∑–µ—Ä–æ",–≤–æ—Å—Ç–æ–∫:"—Ä–æ–≤"}},
    "—Ä–æ–≤":{name:"–ó–∞—Ä–æ—Å—à–∏–π —Ä–æ–≤",desc:"–í—ã—Å–æ–∫–∏–µ —Ç—Ä–∞–≤—ã. –ù–∞ –¥–Ω–µ ‚Äì –∫–æ—Å—Ç–∏ –∏ –±–ª–µ—Å–∫ –º–µ—Ç–∞–ª–ª–∞.",exits:{–∑–∞–ø–∞–¥:"–ª–µ—Å",—é–≥:"–ø–µ—â–µ—Ä–∞"},items:["–º–µ—á_—Ä—É–±–ª–∏"],monster:{hp:60,maxHp:60,name:"–¢—Ä–∞–≤—è–Ω–æ–π –¥—É—Ö",dmg:[3,12],exp:30}},
    "–ø–µ—â–µ—Ä–∞":{name:"–°—ã—Ä–∞—è –ø–µ—â–µ—Ä–∞",desc:"–ö–∞–ø–∞–µ—Ç –≤–æ–¥–∞. –í –≥–ª—É–±–∏–Ω–µ ‚Äì —Å–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä–∏—Å—Ç–∞–ª–ª.",exits:{—Å–µ–≤–µ—Ä:"—Ä–æ–≤"},items:["–∫—Ä–∏—Å—Ç–∞–ª–ª"],randomEvent:{chance:1,msg:"–° –ø–æ—Ç–æ–ª–∫–∞ —Å—ã–ø–µ—Ç—Å—è –ø–µ—Å–æ–∫ ‚Äì –ª–æ–≤—É—à–∫–∞! -10 HP.",effect:"trap"}},
    "—Ä–∞–∑–≤–∞–ª–∏–Ω—ã":{name:"–î—Ä–µ–≤–Ω–∏–µ —Ä–∞–∑–≤–∞–ª–∏–Ω—ã",desc:"–û–±—Ä—É—à–∏–≤—à–∏–µ—Å—è —Å—Ç–µ–Ω—ã. –í —Ü–µ–Ω—Ç–µ—Ä–µ ‚Äì –∞–ª—Ç–∞—Ä—å.",exits:{–≤–æ—Å—Ç–æ–∫:"–∫–æ—Ä–∏–¥–æ—Ä"},items:["–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π_–∫–ª–∏–Ω–æ–∫"],monster:{hp:150,maxHp:150,name:"–ö–∞–º–µ–Ω–Ω—ã–π –≥–æ–ª–µ–º",dmg:[10,20],exp:50}}
  },
  items:{
    "–ø–∏—Å—å–º–æ":{name:"–ø–∏—Å—å–º–æ",desc:"–ö–æ—Ä–æ—Ç–∫–æ–µ –ø–∏—Å—å–º–æ: ¬´–ï—Å–ª–∏ —Ç—ã —ç—Ç–æ —á–∏—Ç–∞–µ—à—å ‚Äì –∑–Ω–∞—á–∏—Ç, —è –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è. –ò—â–∏ –∫–ª—é—á –≤ —à–∫–∞—Ç—É–ª–∫–µ¬ª.",icon:"üìù"},
    "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è":{name:"—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è",desc:"–°–Ω–∏–º–æ–∫: —Ç—ã –∏ —Å–µ—Å—Ç—Ä–∞ —É –æ–∑–µ—Ä–∞. –ù–∞ –æ–±–æ—Ä–æ—Ç–µ –Ω–∞–¥–ø–∏—Å—å ¬´–õ–µ—Ç–æ 1999¬ª.",icon:"üñºÔ∏è"},
    "—à–∫–∞—Ç—É–ª–∫–∞":{name:"—à–∫–∞—Ç—É–ª–∫–∞",desc:"–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è, –∫—Ä–µ–ø–∫–æ –∑–∞–ø–µ—Ä—Ç–∞.",icon:"üóÉÔ∏è"},
    "—á–µ–º–æ–¥–∞–Ω":{name:"—á–µ–º–æ–¥–∞–Ω",desc:"–ö–æ–∂–∞–Ω—ã–π, —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏ ¬´–ê.–®.¬ª –ó–∞–ø–µ—Ä—Ç –Ω–∞ –Ω–∞–≤–µ—Å–Ω–æ–π –∑–∞–º–æ–∫.",icon:"üß≥"},
    "–∫—Ä—é—á–æ–∫":{name:"—Ç–æ–ª—Å—Ç—ã–π –∫—Ä—é—á–æ–∫",desc:"–†–∂–∞–≤—ã–π, –Ω–æ –ø—Ä–æ—á–Ω—ã–π. –ú–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –∑–∞–º–æ–∫.",icon:"ü™ù"},
    "–∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏":{name:"–º–∞–ª–µ–Ω—å–∫–∏–π –∫–ª—é—á",desc:"–õ—ë–≥–∫–∏–π, —Å —É–∑–∫–∏–º —Å—Ç–µ—Ä–∂–Ω–µ–º ‚Äì –ø–æ—Ö–æ–∂–µ, –æ—Ç —à–∫–∞—Ç—É–ª–∫–∏.",icon:"üóùÔ∏è"},
    "–∑–∞–ø–∏—Å–∫–∞":{name:"–∑–∞–ø–∏—Å–∫–∞",desc:"¬´–ö–ª—é—á –æ—Ç —à–∫–∞—Ç—É–ª–∫–∏ —è —Å–ø—Ä—è—Ç–∞–ª –≤ –∫–ª–∞–¥–æ–≤–∫–µ ‚Äì –Ω–∞ –∫—Ä—é—á–∫–µ¬ª.",icon:"üìÑ"},
    "–¥—É–±–∏–Ω–∞":{name:"–¥—É–±–∏–Ω–∞",desc:"–¢—è–∂—ë–ª—ã–π –∫—É—Å–æ–∫ –¥–µ—Ä–µ–≤–∞. +3 –∫ —É—Ä–æ–Ω—É.",icon:"üèè",atk:3},
    "–º–µ—á_—Ä—É–±–ª–∏":{name:"—Å—Ç–∞—Ä—ã–π –º–µ—á",desc:"–†–∂–∞–≤—ã–π, –Ω–æ –æ—Å—Ç—Ä—ã–π. +4 –∫ —É—Ä–æ–Ω—É.",icon:"‚öîÔ∏è",atk:4},
    "–∫—Ä–∏—Å—Ç–∞–ª–ª":{name:"—Å–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä–∏—Å—Ç–∞–ª–ª",desc:"–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –∏–ª–∏ –≤–ø–∏—Ç–∞—Ç—å —Å–∏–ª—É. +5 –æ–ø—ã—Ç–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.",icon:"üíé",exp:5},
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π_–∫–ª–∏–Ω–æ–∫":{name:"–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–ª–∏–Ω–æ–∫",desc:"–ë–ª–µ—Å—Ç–∏—Ç –¥—Ä–µ–≤–Ω–∏–º —Å–≤–µ—Ç–æ–º. +7 –∫ —É—Ä–æ–Ω—É.",icon:"üó°Ô∏è",atk:7},
    "–∫–ª—é—á":{name:"–ª–∞—Ç—É–Ω–Ω—ã–π –∫–ª—é—á",desc:"–¢—è–∂—ë–ª—ã–π, —Å –∑—É–±—á–∏–∫–∞–º–∏ –Ω–µ–æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã.",icon:"üóùÔ∏è"}
  },
  npcs:{},
  triggers:[
    {cond:"has –∫—Ä—é—á–æ–∫ and in –ø–æ–¥–≤–∞–ª and has —á–µ–º–æ–¥–∞–Ω",act:"msg –í—ã –ø–æ–¥–¥–µ–≤–∞–µ—Ç–µ –∑–∞–º–æ–∫ –∫—Ä—é—á–∫–æ–º ‚Äì –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è!;remove —á–µ–º–æ–¥–∞–Ω;give –∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏;give –∑–∞–ø–∏—Å–∫–∞"},
    {cond:"has –∫–ª—é—á_–æ—Ç_—à–∫–∞—Ç—É–ª–∫–∏ and in —á–µ—Ä–¥–∞–∫ and has —à–∫–∞—Ç—É–ª–∫–∞",act:"msg –®–∫–∞—Ç—É–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞! –í–Ω—É—Ç—Ä–∏ ‚Äì –ª–∞—Ç—É–Ω–Ω—ã–π –∫–ª—é—á.;remove —à–∫–∞—Ç—É–ª–∫–∞;give –∫–ª—é—á"},
    {cond:"has –∫–ª—é—á and in –∫–≤–∞—Ä—Ç–∏—Ä–∞",act:"msg –ö–ª—é—á –ø–æ–¥–æ—à—ë–ª –∫ —Å—Ç–∞—Ä–æ–º—É —Å–µ–π—Ñ—É –≤ —Å—Ç–µ–Ω–µ!;create exit –Ω–∞–≤–µ—Ä—Ö —Ñ–∏–Ω–∞–ª;flag –∞–∫—Ç_–∑–∞–≤–µ—Ä—à—ë–Ω"}
  ],
  randomEvents:[
    {chance:0.2,msg:"–ß–∞—Å—ã –Ω–∞ —Å—Ç–µ–Ω–µ –ø—Ä–æ–±–∏–ª–∏ –ø–æ–ª–Ω–æ—á—å.",effect:"none"},
    {chance:0.15,msg:"–í—ã –Ω–∞—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ –ø–∞—É—Ç–∏–Ω—É.",effect:"skip"},
    {chance:0.1,msg:"–ü–æ–¥ –Ω–æ–≥–∞–º–∏ —Ö—Ä—É—Å—Ç–Ω—É–ª–æ —Å—Ç–µ–∫–ª–æ.",effect:"none"}
  ],
  player:{hp:30,maxHp:30,atk:5,def:0,lvl:1,exp:0,expNext:10,freePoints:0,equipped:null}
};

let world=JSON.parse(localStorage.getItem('zworld_save_v1')||JSON.stringify(DEFAULT_WORLD));
function save(){localStorage.setItem('zworld_save_v1',JSON.stringify(world))}
function out(s){const o=document.getElementById('out');o.textContent+='\n'+s;o.scrollTop=o.scrollHeight}
function renderHP(){
  const p=world.player;
  document.getElementById('hearts').textContent='‚ù§Ô∏è'.repeat(Math.ceil(p.hp/10))+'üñ§'.repeat(Math.ceil((p.maxHp-p.hp)/10));
  document.getElementById('lvl').textContent=p.lvl;
  document.getElementById('exp').textContent=p.exp;
  document.getElementById('expNext').textContent=p.expNext;
}
function gainExp(am){
  const p=world.player;
  p.exp+=am;
  while(p.exp>=p.expNext){
    p.exp-=p.expNext;
    p.lvl++;p.freePoints++;p.expNext=10+p.lvl*5;
    out(`üìà –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! +1 –æ—á–∫–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.`);
  }
  renderHP();save();
}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}

/* ---------- –±–æ–µ–≤–æ–π —Ü–∏–∫–ª ---------- */
let combatTurn=null;
function startCombat(){
  const m=world.rooms[world.playerRoom].monster;
  if(!m||m.hp<=0)return;
  out(`‚öîÔ∏è ${m.name} –Ω–∞–ø–∞–¥–∞–µ—Ç! –í–≤–æ–¥–∏—Ç–µ "–∞—Ç–∞–∫–∞" —á—Ç–æ–±—ã –±–∏—Ç—å.`);
  combatTurn=setInterval(()=>{
    if(m.hp<=0){endCombat(true);return;}
    const dmg=rand(m.dmg[0],m.dmg[1])-world.player.def;
    world.player.hp-=Math.max(0,dmg);
    out(`üí• ${m.name} –±—å—ë—Ç –≤–∞—Å –Ω–∞ ${dmg} —É—Ä–æ–Ω–∞.`);
    if(world.player.hp<=0){endCombat(false);return;}
    renderHP();save();
  },3000);
}
function endCombat(win){
  clearInterval(combatTurn);combatTurn=null;
  const m=world.rooms[world.playerRoom].monster;
  if(win){
    out(`üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏ ${m.name}! +${m.exp||30} –æ–ø—ã—Ç–∞.`);
    gainExp(m.exp||30);
    delete world.rooms[world.playerRoom].monster;
  }else{
    out(`üíÄ –í—ã –ø–æ–≥–∏–±–ª–∏. –ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ.`);
    setTimeout(()=>{localStorage.removeItem('zworld_save_v1');location.reload()},2000);
  }
  save();
}

/* ---------- –∫–æ–º–∞–Ω–¥—ã ---------- */
function send(){
  const raw=document.getElementById('in').value.trim();
  if(!raw)return;
  out(`> ${raw}`);
  document.getElementById('in').value='';
  parse(raw.toLowerCase());
  save();
}
function parse(cmd){
  const [a,...b]=cmd.split(' ');const arg=b.join(' ');
  switch(a){
    case'–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è':look();break;
    case'–∏–¥—Ç–∏':go(arg);break;
    case'–≤–∑—è—Ç—å':take(arg);break;
    case'–æ—Å–º–æ—Ç—Ä–µ—Ç—å':examine(arg);break;
    case'–∞—Ç–∞–∫–∞':playerAttack();break;
    default:out('–ù–µ –ø–æ–Ω—è–ª: –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è, –∏–¥—Ç–∏ <–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ>, –≤–∑—è—Ç—å <–ø—Ä–µ–¥–º–µ—Ç>, –æ—Å–º–æ—Ç—Ä–µ—Ç—å <–ø—Ä–µ–¥–º–µ—Ç>, –∞—Ç–∞–∫–∞');
  }
}
function look(){
  const r=world.rooms[world.playerRoom];
  out(`<b>${r.name}</b>\n${r.desc}`);
  if(r.items&&r.items.length)out('–ó–¥–µ—Å—å: '+r.items.map(i=>world.items[i].name).join(', '));
  if(r.exits&&Object.keys(r.exits).length)out('–í—ã—Ö–æ–¥—ã: '+Object.keys(r.exits).join(', '));
  if(r.monster&&r.monster.hp>0)startCombat();
  if(r.randomEvent&&Math.random()<r.randomEvent.chance){
    const e=r.randomEvent;
    out(e.msg);
    if(e.effect==='trap'){world.player.hp-=10;renderHP();}
    if(e.effect==='give'){world.inv.push(e.item);out('–ü–æ–ª—É—á–µ–Ω–æ: '+world.items[e.item].name);}
    delete r.randomEvent;
  }
  checkTriggers();
  renderInv();
}
function go(dir){
  const r=world.rooms[world.playerRoom];
  if(r.exits&&r.exits[dir]){
    if(combatTurn){out('üíÄ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–±–µ–∂–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –±–æ—è!');return;}
    world.playerRoom=r.exits[dir];look();
  }else out('–¢—É–¥–∞ –Ω–µ–ª—å–∑—è.');
}
function take(name){
  const r=world.rooms[world.playerRoom];
  if(!r.items){out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');return;}
  const it=r.items.find(i=>world.items[i].name.toLowerCase()===name);
  if(it){r.items=r.items.filter(x=>x!==it);world.inv.push(it);out('–í–∑—è–ª–∏ '+world.items[it].name);save();renderInv();}
  else out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');
}
function examine(name){
  let it=world.inv.find(i=>world.items[i].name.toLowerCase()===name);
  if(!it){
    const r=world.rooms[world.playerRoom];
    if(r.items)it=r.items.find(i=>world.items[i].name.toLowerCase()===name);
  }
  if(it){const t=world.items[it];out(`${t.icon||'üì¶'} ${t.name} ‚Äì ${t.desc}`);}
  else out('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ.');
}
function playerAttack(){
  const m=world.rooms[world.playerRoom].monster;
  if(!m||m.hp<=0){out('–ù–µ–∫–æ–≥–æ –±–∏—Ç—å.');return;}
  let dmg=world.player.atk;
  const w=world.player.equipped;
  if(w)dmg+=world.items[w].atk||0;
  dmg=rand(dmg-2,dmg+2);
  m.hp-=Math.max(0,dmg);
  out(`‚öîÔ∏è –í—ã –±—å—ë—Ç–µ –Ω–∞ ${dmg} —É—Ä–æ–Ω–∞. –£ –º–æ–Ω—Å—Ç—Ä–∞ ${Math.max(0,m.hp)}/${m.maxHp} HP.`);
  if(m.hp<=0){endCombat(true);return;}
  save();
}

/* ---------- –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å ---------- */
function renderInv(){
  const grid=document.getElementById('invGrid');
  if(!world.inv.length){grid.innerHTML='<small>–ü—É—Å—Ç–æ</small>';return;}
  grid.innerHTML=world.inv.map(i=>{
    const it=world.items[i];
    const eq=world.player.equipped===i?'–°–Ω—è—Ç—å':'–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å';
    return`<div class="invSlot">
      <span class="invIcon">${it.icon||'üì¶'}</span>
      <div><b>${it.name}</b><br><small>${it.desc}</small></div>
      <button onclick="useItem('${i}')">${eq}</button>
    </div>`;
  }).join('');
}
function useItem(id){
  const it=world.items[id];
  if(it.atk){
    if(world.player.equipped===id){world.player.equipped=null;out(`–°–Ω—è–ª–∏ ${it.name}`);}
    else{world.player.equipped=id;out(`–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω ${it.name}`);}
  }
  if(it.exp){world.inv=world.inv.filter(x=>x!==id);gainExp(it.exp);}
  save();renderInv();
}

/* ---------- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ---------- */
function saveGame(){
  const data=JSON.stringify(world,null,2);
  const blob=new Blob([data],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='Takes_save_'+new Date().toISOString().slice(0,10)+'.txt';
  a.click();
  URL.revokeObjectURL(url);
  out('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');
}
function loadGame(){
  const fi=document.createElement('input');
  fi.type='file';fi.accept='.txt,.json';
  fi.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{Object.assign(world,JSON.parse(ev.target.result));save();location.reload();}catch(err){alert('–û—à–∏–±–∫–∞: '+err.message);}
    };
    reader.readAsText(file);
  };
  fi.click();
}

/* ---------- —Ç—Ä–∏–≥–≥–µ—Ä—ã ---------- */
function checkTriggers(){
  if(combatTurn)return;
  world.triggers.forEach(t=>{
    if(testCond(t.cond))t.act.split(';').forEach(cmd=>runTriggerCmd(cmd));
  });
}
function testCond(c){
  let ok=true;
  if(c.includes('has')){
    const items=c.match(/has (\w+)/g);if(items){
      items.forEach(i=>{if(!world.inv.includes(i.replace('has ','')))ok=false;});
    }
  }
  if(c.includes('in')){
    const room=c.match(/in (\w+)/);if(room&&world.playerRoom!==room[1])ok=false;
  }
  return ok;
}
function runTriggerCmd(cmd){
  const[a,...b]=cmd.split(' ');const arg=b.join(' ');
  switch(a){
    case'msg':out(arg);break;
    case'remove':{const r=world.rooms[world.playerRoom];if(r.items)r.items=r.items.filter(i=>i!==arg);break;}
    case'give':if(!world.inv.includes(arg))world.inv.push(arg);break;
    case'flag':world.flags.push(arg);break;
    case'create':{const[dir,name]=arg.split(' ');world.rooms[world.playerRoom].exits[dir]=name;break;}
  }
  renderInv();
}

/* ---------- —Å—Ç–∞—Ä—Ç ---------- */
renderHP();look();save();
document.getElementById('in').addEventListener('keydown',e=>{if(e.key==='Enter')send()});
</script>
</body>
</html>
